name: Auto Stock Screening

# Tự động chạy vào 11:45 và 15:15 múi giờ UTC+7
# UTC+7 -> UTC: 11:45 = 04:45 UTC, 15:15 = 08:15 UTC
on:
  schedule:
    - cron: "45 4 * * 1-5"   # 11:45 UTC+7, Thứ 2 - Thứ 6
    - cron: "15 8 * * 1-5"   # 15:15 UTC+7, Thứ 2 - Thứ 6
  workflow_dispatch:          # Cho phép chạy thủ công

permissions:
  contents: write

jobs:
  screening:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Ho_Chi_Minh

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install vnstock pandas numpy apscheduler pytz
          pip install vnstock_data vnstock_ta vnstock_pipeline vnstock_news 2>/dev/null || true

      - name: Run Stock Screening
        working-directory: python_api
        run: |
          python stock_analyzer.py screen all 10 > screening_results/screening_$(date +%Y%m%d_%H%M).json 2>&1 || true
          echo "Screening completed at $(date '+%Y-%m-%d %H:%M:%S %Z')"

      - name: Save results
        working-directory: python_api
        run: |
          mkdir -p screening_results
          # Copy latest result
          LATEST=$(ls -t screening_results/screening_*.json 2>/dev/null | head -1)
          if [ -n "$LATEST" ]; then
            cp "$LATEST" screening_results/latest.json
            echo "Latest result saved: $LATEST"
          fi

      - name: Commit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add python_api/screening_results/ 2>/dev/null || true
          git diff --staged --quiet || git commit -m "auto: screening $(date '+%Y-%m-%d %H:%M') UTC+7"
          git push || true
